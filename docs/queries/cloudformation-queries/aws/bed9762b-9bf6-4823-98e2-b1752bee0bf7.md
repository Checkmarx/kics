---
title: Secretsmanager Secret Without KMS
hide:
  toc: true
  navigation: true
---

<style>
  .highlight .hll {
    background-color: #ff171742;
  }
  .md-content {
    max-width: 1100px;
    margin: 0 auto;
  }
</style>

-   **Query id:** bed9762b-9bf6-4823-98e2-b1752bee0bf7
-   **Query name:** Secretsmanager Secret Without KMS
-   **Platform:** CloudFormation
-   **Severity:** <span style="color:#ff7213">Medium</span>
-   **Category:** Encryption
-   **CWE:** <a href="https://cwe.mitre.org/data/definitions/326.html" onclick="newWindowOpenerSafe(event, 'https://cwe.mitre.org/data/definitions/326.html')">326</a>
-   **URL:** [Github](https://github.com/Checkmarx/kics/tree/master/assets/queries/cloudFormation/aws/secretsmanager_secret_without_kms)

### Description
AWS Secretmanager should use AWS KMS customer master key (CMK) to encrypt the secret values in the versions stored in the secret<br>
[Documentation](https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-resource-secretsmanager-secret.html)

### Code samples
#### Code samples with security vulnerabilities
```json title="Positive test num. 1 - json file" hl_lines="5"
{
    "Resources": {
        "MySecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "secret description"
            }
        },
        "MySecretResourcePolicy": {
            "Type": "AWS::SecretsManager::ResourcePolicy",
            "Properties": {
                "SecretId": {
                    "Ref": "MySecret"
                },
                "ResourcePolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Resource": "*",
                            "Action": "secretsmanager:*",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": "*"
                            }
                        }
                    ]
                }
            }
        }
    }
}
```
```yaml title="Positive test num. 2 - yaml file" hl_lines="4"
Resources:
  MySecret:
      Type: 'AWS::SecretsManager::Secret'
      Properties:
          Description: secret description
  MySecretResourcePolicy:
      Type: 'AWS::SecretsManager::ResourcePolicy'
      Properties:
          SecretId: !Ref MySecret
          ResourcePolicy:
            Version: 2012-10-17
            Statement:
              - Resource: '*'
                Action: 'secretsmanager:*'
                Effect: Allow
                Principal:
                  AWS: '*'
```
```json title="Positive test num. 3 - json file" hl_lines="8"
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "MySecretB": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": "MySecretForAppB",
        "KmsKeyId" : "",
        "Description": "This secret has a hardcoded password in SecretString (use GenerateSecretString instead)",
        "SecretString": "{\"username\":\"MasterUsername\",\"password\":\"secret-password\"}",
        "Tags": [
          {
            "Key": "AppName",
            "Value": "AppB"
          }
        ]
      }
    }
  }
}
```
<details><summary>Positive test num. 4 - yaml file</summary>

```yaml hl_lines="7"
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  MySecretB:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: MySecretForAppB
      KmsKeyId: ''
      Description: This secret has a hardcoded password in SecretString (use GenerateSecretString
        instead)
      SecretString: '{"username":"MasterUsername","password":"secret-password"}'
      Tags:
        - Key: AppName
          Value: AppB
```
</details>


#### Code samples without security vulnerabilities
```json title="Negative test num. 1 - json file"
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "MyCMK": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": "test",
        "KmsKeyId": "test-key"
      }
    }
  }
}
```
```yaml title="Negative test num. 2 - yaml file"
AWSTemplateFormatVersion: "2010-09-09"
Resources: 
  MyCMK:
    Type: AWS::SecretsManager::Secret
    Properties: 
      Name: test
      KmsKeyId: test-key
```
