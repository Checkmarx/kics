package engine

type VulnerabilityBuilderTransition int

const (
	// YetToBeChecked is a query that has not been checked for transition type
	YetToBeChecked VulnerabilityBuilderTransition = iota
	// NonGracefullyTransition is a query that does not transition to the new version being able to get the old version
	NonGracefullyTransition VulnerabilityBuilderTransition = iota
	// TransitionWithoutChanges is a transition where no changes are made to the query
	TransitionWithoutChanges VulnerabilityBuilderTransition = iota
	// AddedSearchValue is a transition where only the search value is added to the query
	AddedSearchValue VulnerabilityBuilderTransition = iota
	// AddedSearchLine is a transition where only the search line is added the query
	AddedSearchLine VulnerabilityBuilderTransition = iota
	// AddedSearchValueAndAddedSearchLine is a transition where both the search value and search line are added to the query
	AddedSearchValueAndAddedSearchLine VulnerabilityBuilderTransition = iota
)

type VulnerabilityBuilderTransitionQueryInfo struct {
	QueryID    string                         `yaml:"queryId"`
	QueryName  string                         `yaml:"queryName"`
	Transition VulnerabilityBuilderTransition `yaml:"change"`
}

func checkQueryTransitionType(queryID, platform string) VulnerabilityBuilderTransition {
	if mapping, exists := vulnerabilityBuilderTransitionMapping[platform]; exists {
		if transitionType, exists := mapping[queryID]; exists {
			return transitionType
		}
	}
	return YetToBeChecked
}

// VulnerabilityBuilderTransition maps the query mapping per platform and type of vulnerability builder transition
var vulnerabilityBuilderTransitionMapping = map[string]map[string]VulnerabilityBuilderTransition{
	"Kubernetes": {
		"1828a670-5957-4bc5-9974-47da228f75e2": AddedSearchValue,                   // Query Audit Policy Not Cover Key Security Concerns
		"cf34805e-3872-4c08-bf92-6ff7bb0cfadb": AddedSearchValueAndAddedSearchLine, // Container Running As Root
		"02323c00-cdc3-4fdc-a310-4f2b3e7a1660": AddedSearchValueAndAddedSearchLine, // Container Running With Low UID
		"ca469dd4-c736-448f-8ac1-30a642705e0a": AddedSearchValueAndAddedSearchLine, // CPU Requests Not Set
		"09bb9e96-8da3-4736-b89a-b36814acca60": AddedSearchValue,                   // Etcd Peer TLS Certificate Files Not Properly Set
		"075ca296-6768-4322-aea2-ba5063b969a9": AddedSearchValue,                   // Etcd TLS Certificate Files Not Properly Set
		"895a5a95-3756-4b04-9924-2f3bc93181bd": AddedSearchValue,                   // Etcd TLS Certificate Not Properly Configured
		"caa3479d-885d-4882-9aac-95e5e78ef5c2": AddedSearchValueAndAddedSearchLine, // Image Pull Policy Of The Container Is Not Set To Always
		"7c81d34c-8e5a-402b-9798-9f442630e678": AddedSearchValueAndAddedSearchLine, // Image Without Digest
		"36a27826-1bf5-49da-aeb0-a60a30c0e834": AddedSearchValue,                   // Kubelet Client Certificate Or Key Not Set
		"ade74944-a674-4e00-859e-c6eab5bde441": AddedSearchValueAndAddedSearchLine, // Liveness Probe Is Not Defined
		"229588ef-8fde-40c8-8756-f4f2b5825ded": AddedSearchValueAndAddedSearchLine, // Memory Requests Not Defined
		"1123031a-f921-4c5b-bd86-ef354ecfd37a": AddedSearchValueAndAddedSearchLine, // Metadata Label Is Invalid
		"8b36775e-183d-4d46-b0f7-96a6f34a723f": AddedSearchValueAndAddedSearchLine, // Missing AppArmor Profile
		"dbbc6705-d541-43b0-b166-dd4be8208b54": AddedSearchValueAndAddedSearchLine, // NET_RAW Capabilities Not Being Dropped
		"268ca686-7fb7-4ae9-b129-955a2a89064e": AddedSearchValueAndAddedSearchLine, // No Drop Capabilities for Containers
		"94b76ea5-e074-4ca2-8a03-c5a606e30645": AddedSearchValueAndAddedSearchLine, // Object Is Using A Deprecated API Version
		"592ad21d-ad9b-46c6-8d2d-fad09d62a942": AddedSearchValue,                   // Permissive Access to Create Pods
		"4a20ebac-1060-4c81-95d1-1f7f620e983b": AddedSearchValue,                   // Pod or Container Without LimitRange
		"48a5beba-e4c0-4584-a2aa-e6894e4cf424": AddedSearchValue,                   // Pod or Container Without ResourceQuota
		"a97a340a-0063-418e-b3a1-3028941d0995": AddedSearchValueAndAddedSearchLine, // Pod or Container Without Security Context
		"5572cc5e-1e4c-4113-92a6-7a8a3bd25e6d": AddedSearchValueAndAddedSearchLine, // Privilege Escalation Allowed
		"b7bca5c4-1dab-4c2c-8cbe-3050b9d59b14": AddedSearchValue,                   // RBAC Roles with Read Secrets Permissions
		"6b896afb-ca07-467a-b256-1a0077a1c08e": AddedSearchValue,                   // RBAC Wildcard In Rule
		"a659f3b5-9bf0-438a-bd9a-7d3a6427f1e3": AddedSearchValueAndAddedSearchLine, // Readiness Probe Is Not Configured
		"a9c2f49d-0671-4fc9-9ece-f4e261e128d0": AddedSearchValueAndAddedSearchLine, // Root Container Not Mounted Read-only
		"f377b83e-bd07-4f48-a591-60c82b14a78b": AddedSearchValueAndAddedSearchLine, // Seccomp Profile Is Not Configured
		"3d658f8b-d988-41a0-a841-40043121de1e": AddedSearchValueAndAddedSearchLine, // Secrets As Environment Variables
		"48471392-d4d0-47c0-b135-cdec95eb3eef": AddedSearchValueAndAddedSearchLine, // Service Account Token Automount Not Disabled
		"056ac60e-fe07-4acc-9b34-8e1d51716ab9": AddedSearchValue,                   // ServiceAccount Allows Access Secrets
		"6d173be7-545a-46c6-a81d-2ae52ed1605d": AddedSearchValueAndAddedSearchLine, // Tiller (Helm v2) Is Deployed
		"8b862ca9-0fbd-4959-ad72-b6609bdaa22d": AddedSearchValueAndAddedSearchLine, // Tiller Service Is Not Deleted
		"fa750c81-93c2-4fab-9c6d-d3fd3ce3b89f": AddedSearchValue,                   // TSL Connection Certificate Not Setup
		"611ab018-c4aa-4ba2-b0f6-a448337509a6": AddedSearchValue,                   // Using Unrecommended Namespace
		"b7652612-de4e-4466-a0bf-1cd81f0c6063": AddedSearchValue,                   // Volume Mount With OS Directory Write Permissions
	},
}
